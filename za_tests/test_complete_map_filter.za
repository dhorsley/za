#!/usr/bin/env za

println "=== Complete Map and Filter Test with All Dynamic Features ==="

# Test 1: Big integers with filter and map
println "Test 1: Big integers"
big_ints = [1, 2, 3, 4, 5].list_bigi
filtered_bigi = big_ints ?> "# > 3"
mapped_bigi = big_ints -> "# * 2"
println "BigInt filter: ", filtered_bigi
println "BigInt map: ", mapped_bigi

# Test 2: Big floats with filter and map
println "Test 2: Big floats"
big_floats = [1.5, 2.5, 3.5, 4.5, 5.5].list_bigf
filtered_bigf = big_floats ?> "# > 3.0"
mapped_bigf = big_floats -> "# / 2"
println "BigFloat filter: ", filtered_bigf
println "BigFloat map: ", mapped_bigf

# Test 3: Multi-dimensional arrays
println "Test 3: Multi-dimensional arrays"
matrix = [[1, 2, 3], [4, 5, 6], [7, 8, 9]]
filtered_matrix = matrix ?> "#[1] > 4"
mapped_matrix = matrix -> "#[0] + #[2]"
println "Multi-dim filter: ", filtered_matrix
println "Multi-dim map: ", mapped_matrix

# Test 4: Map support in RHS strings
println "Test 4: Map support in RHS"
data_map = map(.name "Alice", .age 30, .score 95.5)
test_array = [data_map, map(.name "Bob", .age 25, .score 87.0)]
filtered_map = test_array ?> "#.age > 28"
mapped_map = test_array -> "#.name + ` (` + as_string(#.age) + `)`"
println "Map filter: ", filtered_map
println "Map map: ", mapped_map

# Test 5: Dirent with field access
println "Test 5: Dirent with field access"
files = dir(".")  # Use smaller directory
filtered_files = files ?> "#.name != `.`"
mapped_files = files -> "#.name"
println "Dirent filter count: ", len(filtered_files)
println "Dirent map (first 3): ", mapped_files[0:3]

# Test 6: Regular arrays (regression test)
println "Test 6: Regular arrays regression"
regular = [10, 20, 30, 40, 50]
filtered_reg = regular ?> "# > 25"
mapped_reg = regular -> "# + 1000"
println "Regular filter: ", filtered_reg
println "Regular map: ", mapped_reg

# Test 7: String arrays
println "Test 7: String arrays"
strings = ["apple", "banana", "cherry", "date"]
filtered_strings = strings ?> "# > `b`"
mapped_strings = strings -> "# + `_fruit`"
println "String filter: ", filtered_strings
println "String map: ", mapped_strings

# Test 8: Complex nested operations (simplified)
println "Test 8: Complex nested operations"

# Test simple nested map first
nested_map = map(.user map(.name "Alice", .scores [95, 87, 92]), .active true)
println "Nested map:", nested_map

# Test array of simple maps
simple_data = [map(.name "Alice", .active true), map(.name "Bob", .active false)]
filtered_simple = simple_data ?> "#.active"
mapped_simple = simple_data -> "#.name"
println "Simple filter:", filtered_simple.pp
println "Simple map:", mapped_simple.pp

# Test 9: $idx Index Replacement
println "Test 9: Index replacement with $idx"
numbers = [10, 20, 30, 40]
indexed_map = numbers -> `"index_$idx: #"`
indexed_filter = numbers ?> "$idx > 1"
println "Indexed map: ", indexed_map
println "Indexed filter: ", indexed_filter

# Test 10: @ Container Literal Replacement
println "Test 10: Container literal replacement with @"
data = [map(.name "Alice"), map(.name "Bob")]
field_map = data -> `User: #.name, Full data: @`
println "Field map: ", field_map

# Test 11: Result Type Detection
println "Test 11: Result type detection"
mixed_input = [map(.name "Alice"), map(.name "Bob")]
string_result = mixed_input -> "#.name"
println "Result type: ", kind(string_result)
println "Result: ", string_result

# Test 12: Edge Cases
println "Test 12: Edge cases"
empty_array = []
empty_result = empty_array -> "# + 1"
println "Empty array result: ", empty_result, " (type: ", kind(empty_result), ")"

# Test 13: Complex Combined Features
println "\nTest 13: Complex combined features"
complex_data = [map(.items [1, 2, 3]), map(.items [4, 5, 6])]
# println "input data : ",complex_data.pp
complex_result = complex_data -> `map(.item_$idx @.items[0] + @.items[2])`
println "result : ", complex_result.pp

println "=== All tests completed successfully! ==="
