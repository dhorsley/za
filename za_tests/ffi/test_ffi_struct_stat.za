#!/usr/bin/env za

# Test struct marshaling with "out" parameters using stat()

println "Testing struct marshaling with stat() system call"
println "This demonstrates handling C functions that fill struct data (out parameters)"

# Load libc with AUTO to import struct and function definitions from C headers
if release_id()=="ubuntu"
    module "libc.so" as c auto "/usr/include/x86_64-linux-gnu/sys/stat.h"
else
    module "libc.so.6" as c auto "/usr/include/sys/stat.h"
endif
use +c

println "\nTest 1: Declare C struct variable"
var statbuf c::stat
println "✓ Struct variable declared"

println "\nTest 2: Call c::stat() to fill the struct"
result = c::stat("/tmp", mut statbuf)
println "Result code:", result

if result != 0
    println "✗ stat() call failed"
    exit 1
endif
println "✓ stat() call succeeded - C function filled the struct"

println "\nTest 3: Access struct data directly"
println "✓ Struct accessible via dot notation"

println "\nTest 4: Verify struct data"
println "  File size:", statbuf.st_size
println "  File mode:", statbuf.st_mode
println "  UID:", statbuf.st_uid
println "  GID:", statbuf.st_gid

if statbuf.st_mode > 0
    println "✓ Struct contains valid data (mode = {statbuf.st_mode})"
else
    println "✗ Struct mode is invalid"
endif

println "\nTest 5: Cleanup"
println "✓ Automatic cleanup (struct is stack-allocated)"

println "\nAll stat() struct marshaling tests passed!"
println "\nSummary:"
println "  1. Imported struct stat from C headers via AUTO clause"
println "  2. Declared struct variable with Za type system"
println "  3. Passed struct by reference to C function"
println "  4. C function filled the struct with data"
println "  5. Successfully read file metadata via direct field access"

