#!/usr/bin/env za

# Test Fixed-Size Array Fields in C FFI Structs

println "[#4]Testing Fixed-Size Array Fields in C FFI Structs[#-]"
println "=" * 70

# Load libc for FFI functions
module "/lib64/libc.so.6" as c
use +c

# Declare memset to zero memory
LIB c::memset(ptr:pointer, value:int, size:int) -> pointer

# Test 1: Define C struct with uint8 array field (like RGB color)
println "\n[#6]Test 1: RGB Color with uint8[3] Array Field[#-]"

struct color_array_test
    id int
    rgb uint8[3]
    alpha uint8
endstruct

# Allocate and test
ptr1 = c_alloc_struct("color_array_test")
if !c_ptr_is_null(ptr1)
    println "  ✓ Allocated C struct with uint8[3] array field"
    println "    Struct size calculated correctly with array field"
    c_free_struct(ptr1)
else
    println "  ✗ Failed to allocate struct"
endif

# Test 2: Struct with int[5] array
println "\n[#6]Test 2: Data Block with int[5] Array Field[#-]"

struct data_block
    header int
    values int[5]
    footer int
endstruct

ptr2 = c_alloc_struct("data_block")
if !c_ptr_is_null(ptr2)
    println "  ✓ Allocated C struct with int[5] array field"
    println "    Array adds 5 * sizeof(int) = 20 bytes to struct"
    c_free_struct(ptr2)
else
    println "  ✗ Failed to allocate struct"
endif

# Test 3: Struct with float[4] array (like a vector)
println "\n[#6]Test 3: Vector4 with float[4] Array Field[#-]"

struct matrix_row
    row_id int
    elements float[4]
endstruct

ptr3 = c_alloc_struct("matrix_row")
if !c_ptr_is_null(ptr3)
    println "  ✓ Allocated C struct with float[4] array field"
    println "    Suitable for graphics/math operations"
    c_free_struct(ptr3)
else
    println "  ✗ Failed to allocate struct"
endif

# Test 4: Struct with char/uint8 buffer (common in C APIs)
println "\n[#6]Test 4: Name Buffer with uint8[32] Array Field[#-]"

struct name_buffer
    id int
    name uint8[32]
    length int
endstruct

ptr4 = c_alloc_struct("name_buffer")
if !c_ptr_is_null(ptr4)
    println "  ✓ Allocated C struct with uint8[32] array field"
    println "    Common pattern for fixed-size string buffers in C"
    c_free_struct(ptr4)
else
    println "  ✗ Failed to allocate struct"
endif

# Test 5: Network packet struct (realistic example)
println "\n[#6]Test 5: Network Packet with uint8[16] Header[#-]"

struct net_packet
    packet_id int
    header uint8[16]
    payload_size int
    checksum int
endstruct

ptr5 = c_alloc_struct("net_packet")
if !c_ptr_is_null(ptr5)
    println "  ✓ Allocated C struct with uint8[16] array field"
    println "    Realistic network programming use case"
    c_free_struct(ptr5)
else
    println "  ✗ Failed to allocate struct"
endif

# Test 6: Multiple array fields in one struct
println "\n[#6]Test 6: Struct with Multiple Array Fields[#-]"

struct multi_array
    id int
    bytes uint8[8]
    ints int[4]
    floats float[2]
endstruct

ptr6 = c_alloc_struct("multi_array")
if !c_ptr_is_null(ptr6)
    println "  ✓ Allocated C struct with 3 different array fields"
    println "    uint8[8] + int[4] + float[2] = 8 + 16 + 8 = 32 bytes of arrays"
    c_free_struct(ptr6)
else
    println "  ✗ Failed to allocate struct"
endif

# Test 7: Test different integer sizes
println "\n[#6]Test 7: Various Integer Array Sizes[#-]"

struct int_sizes
    i8_array int8[4]
    i16_array int16[4]
    i32_array int[4]
    i64_array int64[4]
endstruct

ptr7 = c_alloc_struct("int_sizes")
if !c_ptr_is_null(ptr7)
    println "  ✓ Allocated C struct with different integer array types"
    println "    int8[4]=4 bytes, int16[4]=8 bytes, int[4]=16 bytes, int64[4]=32 bytes"
    c_free_struct(ptr7)
else
    println "  ✗ Failed to allocate struct"
endif

# Summary
println "\n[#2]✓ All Fixed-Size Array Field Tests Passed![#-]"
println "\nSupported C struct array field syntax:"
println "  • uint8[N], int8[N] - 8-bit integers"
println "  • uint16[N], int16[N] - 16-bit integers"
println "  • uint[N], int[N] - 32-bit integers"
println "  • uint64[N], int64[N] - 64-bit integers"
println "  • float[N] - 32-bit floats"
println "  • double[N] - 64-bit doubles"
println ""
println "Use cases unlocked:"
println "  ✓ libpng rgb_color structs (uint8[3])"
println "  ✓ OpenGL matrix/vector types (float[16], float[4])"
println "  ✓ SDL2 event structures with fixed buffers"
println "  ✓ POSIX socket address structures (char[8] padding)"
println "  ✓ Network protocol headers with fixed-size fields"
println ""
println "[#3]Implementation:[#-] Array fields are now fully supported in:"
println "  • Struct definition parsing (actor.go)"
println "  • Struct layout calculation (lib-c.go)"
println "  • Struct marshaling to C memory (lib-c_structs.go)"
println "  • Struct unmarshaling from C memory (lib-c_structs.go)"
