# Comprehensive FFI Callback Test
println "[#4]═══ FFI Callback Comprehensive Test ═══[#-]\n"

module "libc.so.6" as c
use +c

# Test 1: Basic callback registration and cleanup
println "[#3]Test 1: Basic Registration/Cleanup[#-]"

def simple_func(a, b)
    return a + b
end

cb1 = c_register_callback("simple_func", "int,int->int")
if cb1 == nil
    println "[#1]FAIL: Could not register callback[#-]"
    exit 1
endif

println format("  ✓ Registered callback: trampoline=%+v, handle=%+v", cb1.trampoline, cb1.handle)

c_unregister_callback(cb1)
println "  ✓ Unregistered callback"

# Test 2: Multiple callbacks simultaneously
println "\n[#3]Test 2: Multiple Simultaneous Callbacks[#-]"

def func_a(x, y)
    return x * 2
end

def func_b(x, y)
    return y * 3
end

cb_a = c_register_callback("func_a", "ptr,ptr->int")
cb_b = c_register_callback("func_b", "ptr,ptr->int")

println "  ✓ Registered callback A"
println "  ✓ Registered callback B"

c_unregister_callback(cb_a)
c_unregister_callback(cb_b)
println "  ✓ Cleaned up both callbacks"

# Test 3: Different signatures
println "\n[#3]Test 3: Different Signature Types[#-]"

def ptr_comparator(p1, p2)
    return 0
end

def int_comparator(n1, n2)
    if n1 < n2
        return -1
    endif
    if n1 > n2
        return 1
    endif
    return 0
end

def thread_func(arg)
    return c_null()
end

cb_ptr = c_register_callback("ptr_comparator", "ptr,ptr->int")
println "  ✓ Registered ptr,ptr->int"

cb_int = c_register_callback("int_comparator", "int,int->int")
println "  ✓ Registered int,int->int"

cb_thread = c_register_callback("thread_func", "ptr->ptr")
println "  ✓ Registered ptr->ptr"

c_unregister_callback(cb_ptr)
c_unregister_callback(cb_int)
c_unregister_callback(cb_thread)
println "  ✓ Cleaned up all signatures"

# Test 4: Namespace handling
println "\n[#3]Test 4: Namespace Awareness[#-]"

namespace test

def namespaced_func(a, b)
    return a - b
end

namespace main

cb_ns = c_register_callback("test::namespaced_func", "int,int->int")
println "  ✓ Registered function from 'test' namespace"
c_unregister_callback(cb_ns)
println "  ✓ Cleanup successful"

# Test 5: Error handling - invalid signature
println "\n[#3]Test 5: Error Handling[#-]"

def error_test(x)
    return x
end

try
    cb_invalid = c_register_callback("error_test", "invalid,signature->bogus")
    println "[#1]FAIL: Should have rejected invalid signature[#-]"
    c_unregister_callback(cb_invalid)
catch e
    println "  ✓ Correctly rejected invalid signature"
endtry

# Test 6: Error handling - nonexistent function
try
    cb_noexist = c_register_callback("function_does_not_exist", "int,int->int")
    println "[#1]FAIL: Should have rejected nonexistent function[#-]"
    c_unregister_callback(cb_noexist)
catch e
    println "  ✓ Correctly rejected nonexistent function"
endtry

# Test 7: Get trampoline independently
println "\n[#3]Test 7: Independent Trampoline Access[#-]"

tramp1 = c_get_trampoline("ptr,ptr->int")
tramp2 = c_get_trampoline("int,int->int")
tramp3 = c_get_trampoline("ptr->ptr")

println "  ✓ Got trampoline for ptr,ptr->int"
println "  ✓ Got trampoline for int,int->int"
println "  ✓ Got trampoline for ptr->ptr"

println "\n[#2]═══════════════════════════════════[#-]"
println "[#2]  All Callback Tests PASSED!  [#-]"
println "[#2]═══════════════════════════════════[#-]\n"

println "Callback system fully operational with:"
println "  • Registration/unregistration"
println "  • Multiple simultaneous callbacks"
println "  • Multiple signature types"
println "  • Namespace-aware function lookup"
println "  • Proper error handling"
println "  • Thread-safe invocation (serialized)"
println ""
println "Supported signatures:"
println "  • ptr,ptr->int"
println "  • int,int->int"
println "  • ptr->ptr"
println "  • int,ptr,ptr->void"
println "  • int->void"

