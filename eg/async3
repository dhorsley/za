#!/usr/bin/za -S

doc `
!!                                                  !!
!! co-processing in child shell *must* be disabled  !!
!!      in order to allow parallel execution        !!
!!                                                  !!
!!      there's still a good chance the parent      !!
!!      shell won't keep up either!                 !!
!!                                                  !!
`

# max=460
max=200

coproc(false)

define f()
    # generally, do some work in here..
    datepath="/usr/bin"
    on release_id()=="ubuntu" do datepath="/bin"
    datecmd="{datepath}/date --rfc-3339=ns"
    on has_start(os(),"freebsd") do datecmd="date"
    on os()=="windows" do datecmd="date /T"
    z =| {datecmd}
    return z.out
end

# launch all in parallel
for x=0 to max
    async hndmap f() x
endfor

# collect results
println "Waiting for task completions."
res=await(ref hndmap,true)
for e=0 to max
    println e," -> ",res[e]
endfor

