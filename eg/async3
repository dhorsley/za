#!/usr/bin/za -S

doc `
!! co-processing in child shell *must* be disabled  !!
!!       in order to allow parallel execution       !!
`

coproc(false)
locks(true)


define f()
    # generally, do some work in here..
    datepath="/usr/bin"
    on release_id()=="ubuntu" do datepath="/bin"
    datecmd="{datepath}/date --rfc-3339=ns"
    on hasstart(os(),"freebsd") do datecmd="date"
    z =| {datecmd}
    pause rand(2000)
    return z
enddef

# launch all in parallel
for x=0 to 99
    async hndmap f() x
endfor

# collect results
println "Waiting for task completions."
res=await(hndmap,true)
for e=0 to 99
    println e," -> ",res[e]
endfor

