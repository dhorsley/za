#!/usr/bin/za

module "mod_build/defines"

input target optarg 1
input do_upx optarg 2

tgt="libc"
on target!="" do tgt=target

upx_enable=false
on do_upx=="upx" do upx_enable=true


#
# main
#

GCLIMIT = "GOGC=450 GOMAXPROCS=4"

bvers =  "1.0.4"
bdate =| date "+%d-%m-%Y %H:%M"

ufound=| which upx | wc -l
ufound=int(ufound)

strip_opts="-s -w"

when lower(tgt)
is "alpine"
    if buildMusl(bvers,bdate,strip_opts,upx_enable)!=0
        print "Failed to build alpine version.\n"
        exit 1
    endif
is "libc"
    if buildLibc(bvers,bdate)!=0
        print "Failed to build libc version.\n"
        exit 1
    endif
is "win"
    if buildWin(bvers,bdate)!=0
        print "Failed to build windows version.\n"
        exit 1
    endif
endwhen

if ufound==1
    | strip {strip_opts} za
    if upx_enable
        | upx za
    endif
else
    print "[#6]Note: Please consider installing the upx package for compressing the binary.[#-]\n"
endif


print "[#4]Installing to /usr/bin/[#-]\n\n"
| sudo cp -f za /usr/bin
| sudo chmod 755 /usr/bin/za


